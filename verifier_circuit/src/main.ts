import { readFileSync, writeFileSync } from "fs";
import { ForeignGroup } from "o1js";
import { Verifier } from "./verifier/verifier.js";
import { deserOpeningProof } from "./serde/serde_proof.js";
import { ForeignField } from "./foreign_fields/foreign_field.js";

let inputs;
try {
    inputs = JSON.parse(readFileSync("./src/inputs.json", "utf-8"));
} catch (e) {
    console.log("Using default inputs");
    inputs = {
        lr: [
            [
                {
                    x: "6308889751096099866652634478310470437254406877827504753430299559788664205001",
                    y: "1261750834092957872467204948292293087695515411033733629284033367828383522570"
                },
                {
                    x: "19854112198520883266389249217549185884087081355600983078852498459042383084145",
                    y: "10274305587750404430622364182052449629429977894755315941870769338916115100993"
                }
            ],
            [
                {
                    x: "28617107695458951203848072805051014233695402751771506113715072820507995147522",
                    y: "5074037994721466833292329813669141479167535625727914615525737497993130729251"
                },
                {
                    x: "26313064866509329103757398158241108695221176613052456402359923687543917996531",
                    y: "11841363156443067014558682118744692955840604731113990256866839226950587303352"
                }
            ],
            [
                {
                    x: "2183261934137656726444281473517337980824052156387211941126112432018105078025",
                    y: "5638221115412924980864988725827409548934000648603917194198519267080981931617"
                },
                {
                    x: "14594528876970717732531815317267945038636801911057351333470742501025000521069",
                    y: "14622096608456269010344732635816080007225869637588700300065169396033722000301"
                }
            ],
            [
                {
                    x: "5954851814188657032016344878169283368720231434604631739587598057008923653705",
                    y: "15865618704224787044186113892919715807769419969461896678559658701996650361219"
                },
                {
                    x: "6176444081296697646073273253811085716715079941592812316486453333532633657453",
                    y: "13658943364785734211775578793088115769283686208088605536723968193818599791872"
                }
            ],
            [
                {
                    x: "22266181407019305344416224588176472816195970241685230907024208701684282978475",
                    y: "24829112811516336395004970477425935830541336338337067367979189673646516894509"
                },
                {
                    x: "12030436190130954490507309747022873843843539186461262647530276893456833011450",
                    y: "2167512100527815254343581272708111766652112169488672340805293000849926401188"
                }
            ],
            [
                {
                    x: "784427757665595449680996310324536240190545554033100772955372772822978027058",
                    y: "5904046592831026376626132184098229133944255248864629420661932123390410673379"
                },
                {
                    x: "19590476873903034895849696275450358581629715737050761418834574872919894258052",
                    y: "25471261277073757029540024405800873456501447159652376129652494249314311614780"
                }
            ],
            [
                {
                    x: "14919479403101635259698315755702116535344486624293745675856480046899582724826",
                    y: "17930003579726066858671781781627225357511359364664607935262929303422542263342"
                },
                {
                    x: "18296058561931958478712106684150634816103875865006766838771317661457991357701",
                    y: "2224885933786104920981936447101966682720264445783161491113182336646894787975"
                }
            ],
            [
                {
                    x: "2880251818786045461530635618066001154546702575319143646997519870707025848542",
                    y: "28505552606344582066869373337013698219699589190744376295568528280178978820892"
                },
                {
                    x: "2554238076789601110018962814342629561080121646001501490078644083473995068409",
                    y: "15405781706488260369989124035242838155151432123471248181860467689872436684956"
                }
            ],
            [
                {
                    x: "8407523915038373978710227898917416869408117754319710450650355568773831172260",
                    y: "27430712543224366492988539611026691005570510875371358692338688766479485249289"
                },
                {
                    x: "23225039831813773202125663614896036417080243697910724288638431774686347995204",
                    y: "23716256358317759597784895298657519634141934393316958884294783067920996346427"
                }
            ],
            [
                {
                    x: "15717674832467832899906922561055266299511925597485855214934229975650344017896",
                    y: "8957859097489000967544710464697647438067111142462250276811791404165667071618"
                },
                {
                    x: "2896395419331027865763025570325431190893407691671717119477841249144294984249",
                    y: "23399175071813040329216353348158249864438475183416496843134309648552468905457"
                }
            ],
            [
                {
                    x: "19244049167326549781898924709943002310538363708302813625445469369369553812997",
                    y: "8857809868130414834427941916636597316249254910086071560674431697028504578600"
                },
                {
                    x: "28882206782396775439722515099758400585030953411985067956171531521645160303338",
                    y: "23273245601832469746437960524525107963463685173554683824474064209004010977644"
                }
            ],
            [
                {
                    x: "13363666536267095738839097764992742156856315001531781799676171743481575759011",
                    y: "26107144361322111610871777916639853922243450399093120271817929472186827356220"
                },
                {
                    x: "6879787456556182300706079384345501987720465181159879437158697179458368849590",
                    y: "847020099166463559425664047902732130819371338027106864251202374273412819027"
                }
            ],
            [
                {
                    x: "1195882757526515866347338581647020378065895027251519986799419075871652633527",
                    y: "154919439575985690706087424955554392329366487554007549107789346739492763416"
                },
                {
                    x: "9045517457760004689255241885754092005000269059138201210173010017421298038310",
                    y: "16827399152302290734200623703463702123312252237121365080772068914411818527934"
                }
            ],
            [
                {
                    x: "28926139221540261436218825605754289263723980493364305876642796438643426188056",
                    y: "27928750175496637969956349774354178664799832754408858785796664817412048823352"
                },
                {
                    x: "11006321109888228036627453662592274901774089120264249560688664723435957710717",
                    y: "15406730127550031771085570099357729111028876654113872545646116919535544412011"
                }
            ],
            [
                {
                    x: "3258055168692036828418535867580518762754405474467282063689379220750145864017",
                    y: "27163666501230034225968054907870088721996849749770947582909336283594798491663"
                },
                {
                    x: "4635928000278748971421514790921841258141141860238914303758093683832467193261",
                    y: "23347874209786878710938376979071620945793479136117039876096534778549386086010"
                }
            ],
            [
                {
                    x: "9469536087426574235168606189514162393115802602398625185774518004985266865466",
                    y: "18363680692584449684367793006274534482804936905344646290527732357366731819272"
                },
                {
                    x: "4670460051121700803740082406271796203605151944229104004898586794402327781900",
                    y: "6416465795609466569887721009735104604698802736366061381647609875481059857571"
                }
            ],
            [
                {
                    x: "11395983651300962557644179149234370772117591851609969075908704311451481210884",
                    y: "15966833843171658618443450808231776191417605022435627315375718330037722629389"
                },
                {
                    x: "28280683279476250156000233565824249222555944600995237240713664616502743138240",
                    y: "5988031261886270558392486467669345264886400097105503986547236638345552615913"
                }
            ]
        ],
        z1: "20060744395697394165949488190638351070028800840281140797950401179201503443374",
        z2: "17083635881322686117899354360530886420794787368463562965325130958147905342869",
        delta: {
            x: "5587584532691515615198889469311300008947272261237263002699596929405653488653",
            y: "22407549603551775743132131273591019829249861678689490607607985137460890722011"
        },
        sg: {
            x: "18360386270007864862609936998354073899600191160805551081533540062378657112063",
            y: "16900838421795507553416407755833565072281017209844912928681334158774298324278"
        },
        expected: {
            x: "20119283514495100684642015099347989791405142260701452946933199983604783927028",
            y: "10396951838147144327109712054570315735893579866456277868403120404383354000964"
        }
    };
}

console.log('O1JS loaded');

// ----------------------------------------------------

ForeignGroup.curve = [
    "0", // a
    "2", // b
    "16798108731015832284940804142231733909889187121439069848933715426072753864723", // modulus
    "16798108731015832284940804142231733909889187121439069848933715426072753864722", // gen_x
    "1", // gen_y
    "16798108731015832284940804142231733909759579603404752749028378864165570215949" // order
];

console.log("Generating circuit keypair...");
let keypair = await Verifier.generateKeypair();

console.log("Proving...");
let openingProof = deserOpeningProof(inputs);
let expected_x = ForeignField.from(inputs.expected.x);
let expected_y = ForeignField.from(inputs.expected.y);
let expected = new ForeignGroup(expected_x, expected_y);
let proof = await Verifier.prove([], [openingProof, expected], keypair);
console.log(proof);

console.log("Writing circuit gates into file...");
let gates = keypair.constraintSystem();
writeFileSync("../kzg_prover/gates.json", JSON.stringify(gates));

// ----------------------------------------------------
console.log('Shutting down O1JS...');
