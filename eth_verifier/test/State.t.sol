// SPDX-License-Identifier: GPL-3.0
pragma solidity >=0.4.16 <0.9.0;

import {Test, console2} from "forge-std/Test.sol";
import "../src/Verifier.sol";
import "../lib/msgpack/Deserialize.sol";

contract StateTest is Test {
    KimchiVerifier verifier;

    function setUp() public virtual {
        bytes memory urs_serialized =
            hex"82A866756C6C5F73727382A1679382A474797065A6427566666572A464617461DC0020010000000000000000000000000000000000000000000000000000000000000082A474797065A6427566666572A464617461DC0020343FCC9B2FCC88177D5317CCC5CCE46D58775535CCFBCCF727CCAECCFDCC9ACC8F7CCCD71FCC97CCB65DCCF3CC88CC8982A474797065A6427566666572A464617461DC00204A43CCA4CC91CCBECCFACCA9CCF4CC8307CCAB053DCCE15301CC8904CC885BCCB27ECC8F547A4E1FCCD0CC8BCC864B0DA16882A474797065A6427566666572A464617461DC0020723737CCCF1CCCC96BCCB40021504A4FCCF45D21CC914ECC94CC84CCF2113D66545A3826CC91CC9ACC9C25AC76657269666965725F73727382A1679382A474797065A6427566666572A464617461DC0040CCEDCCF6CC92CCD95CCCBDCCDE46CCDDCCDA5ECCF7CCD422436779445C5E66006A42761E1F12CCEFCCDE0018CCC212CCF3CCAECCB7CC85CCE4CC9712CCE7CCA9353349CCAACCF1255DCCFB31CCB7CCBF60723A480DCC92CC93CC93CC8E1982A474797065A6427566666572A464617461DC0040CCE7CCE6CCAFCC991BCC936DCCD662CCCACCAE0472CCBA13CC801C5F3ACCA3CCAD44CC863D0F090DCC9ACCC8CCA86D11CC91CC9A5606733ACC9E0630CCA5CCE2CCD0CCB1670DCCE93CCCE8CCCC6FCCB0496A7BCCB715CC96CCBA340974CC9282A474797065A6427566666572A464617461DC0040CCA50DCCF21272CCDA0FCC9044CCEACCE527CCA975CCCC3619CCD5CCEB45CCA57A7B3203472A20CCCB073C1FCCF74FCCF90657CCBDCCBECCE361CCD2CC90CCFACCB566CCF5CC8FCCC8CC921F7646CC8DCCEF43CC94CCB6611D25CC9242CC8AA16882A474797065A6427566666572A464617461DC00406959CCBECCF6615463CCA54CCCA6CCC72DCCFCCCD02B6B77CC9ECCDE23400D55CCB043CC984B2206CC92012A00CCF4CCA9CCF6CCBDCCB1CCD34ECCD1CCA57C0E4140CCA0CCCFCCF3CCEFCCB0CCCE24CC844CCCC6CCEDCC9DCCA8CCFC573ECC982D";
        verifier = new KimchiVerifier();
        verifier.setup(urs_serialized);
    }

    function test_verify_retrieve() public {
        bytes
            memory state_serialized = hex"93d937423632716a3238374c3162775039586775555262785735636e65545244384b6465347678336662655a434e784e78794d7a586473594c50d94b353238373731323331373633313534353334393439333639393138373535393036313938343735383336323633353931373132333136363738373232363934373434363136323434343035a6333033323130";
        bytes
            memory proof_serialized = hex"137B386B60C0B1EACD825BB5D7F8F9A75311C21BEB8A78AD4B1B917429DEB83C081677AECD36470CE9D97D4F7927F35B8D12315EF38A6E7D013866250B59CE892C5318092D9CFD60953C21CEC7596C081C244651BAB13D833D32C994713866320F62347F68390EF9243D355B0D5145E131BB25D9BD5FC198D6851C72CAFA647F1607206363F7EA00E0CE50C0B1DA51BAFE0B76CDCDDBAD364B0A4095CD589A19083C4DA5D257B99D25229FCF3B3885BB6D56FE821E8174C6F8F2B6671517F68B2692D3B51BB5602EEB3B9834B616E57FEE7283D7EA28F22E4263D78D90DB80A5003B6053211EE23338A695E2CFEFB1CE44D5458D0FB783A40F87C6D5C8AD90BE";
        verifier.verify_state(state_serialized, proof_serialized);
        assertEq(
            verifier.retrieve_state_creator(),
            "B62qj287L1bwP9XguURbxW5cneTRD8Kde4vx3fbeZCNxNxyMzXdsYLP"
        );
        assertEq(
            verifier.retrieve_state_hash(),
            528771231763154534949369918755906198475836263591712316678722694744616244405
        );
        assertEq(verifier.retrieve_state_height(), 303210);
    }
}
