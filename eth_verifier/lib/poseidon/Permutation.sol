// SPDX-License-Identifier: GPL-3.0
pragma solidity >=0.4.16 <0.9.0;

import "../bn254/Fields.sol";

/// configured specifically for Kimchi
library Poseidon {
    using {Base.inv, Base.mul, Base.add} for Base.FE;

    function sbox(Base.FE elem) public pure returns (Base.FE) {
        return Base.pow(elem, 7);
    }

    function apply_mds(
        Base.FE[3] memory state
    ) public pure returns (Base.FE[3] memory n) {
        Base.FE[3][3] memory mds = [
            [
                Base.from(
                    12035446894107573964500871153637039653510326950134440362813193268448863222019
                ),
                Base.from(
                    25461374787957152039031444204194007219326765802730624564074257060397341542093
                ),
                Base.from(
                    27667907157110496066452777015908813333407980290333709698851344970789663080149
                )
            ],
            [
                Base.from(
                    4491931056866994439025447213644536587424785196363427220456343191847333476930
                ),
                Base.from(
                    14743631939509747387607291926699970421064627808101543132147270746750887019919
                ),
                Base.from(
                    9448400033389617131295304336481030167723486090288313334230651810071857784477
                )
            ],
            [
                Base.from(
                    10525578725509990281643336361904863911009900817790387635342941550657754064843
                ),
                Base.from(
                    27437632000253211280915908546961303399777448677029255413769125486614773776695
                ),
                Base.from(
                    27566319851776897085443681456689352477426926500749993803132851225169606086988
                )
            ]
        ]; // taken from kimchi's dummy values

        n[0] = state[0].mul(mds[0][0]).add(state[1].mul(mds[0][1])).add(
            state[2].mul(mds[0][2])
        );
        n[1] = state[0].mul(mds[1][0]).add(state[1].mul(mds[1][1])).add(
            state[2].mul(mds[1][2])
        );
        n[2] = state[0].mul(mds[2][0]).add(state[1].mul(mds[2][1])).add(
            state[2].mul(mds[2][2])
        );
    }

    function apply_round(
        uint round,
        Base.FE[3] memory state
    ) public pure returns (Base.FE[3] memory new_state) {
        Base.FE[3][55] memory round_constants = [
            [
                Base.from(
                    21155079691556475130150866428468322463125560312786319980770950159250751855431
                ),
                Base.from(
                    16883442198399350202652499677723930673110172289234921799701652810789093522349
                ),
                Base.from(
                    17030687036425314703519085065002231920937594822150793091243263847382891822670
                )
            ],
            [
                Base.from(
                    2521671823712948275272127644536869205999790188065404788363027634642145742736
                ),
                Base.from(
                    9054264347380455706540423067244764093107767235485930776517975315876127782582
                ),
                Base.from(
                    26439087121446593160953570192891907825526260324480347638727375735543609856888
                )
            ],
            [
                Base.from(
                    1525100079081726116963939449685183173381993059612521431308418252661085578749
                ),
                Base.from(
                    10861916012597714684433535077722887124099023163589869801449218212493070551767
                ),
                Base.from(
                    18597653523270601187312528478986388028263730767495975370566527202946430104139
                )
            ],
            [
                Base.from(
                    1583141645419864427656331900680549004946032222905775646258002918184758900661
                ),
                Base.from(
                    15171856919255965617705854914448645702014039524159471542852132430360867202292
                ),
                Base.from(
                    15488495958879593647482715143904752785889816789652405888927117106448507625751
                )
            ],
            [
                Base.from(
                    1903980267998306348813430467099872594984265519928996196780122396983982394015
                ),
                Base.from(
                    4720101937153217036737330058775388037616286510783561045464678919473230044408
                ),
                Base.from(
                    10226318327254973427513859412126640040910264416718766418164893837597674300190
                )
            ],
            [
                Base.from(
                    2087875613112921840692051585923513727585984463830196788944126203014603183881
                ),
                Base.from(
                    7178475685651744631172532830973371642652029385893667810726019303466125436953
                ),
                Base.from(
                    1996970955918516145107673266490486752153434673064635795711751450164177339618
                )
            ],
            [
                Base.from(
                    1520554591643415746492942014575689732148231479891015357534043081722250467263
                ),
                Base.from(
                    25660296961552699573824264215804279051322332899472350724416657386062327210698
                ),
                Base.from(
                    13842611741937412200312851417353455040950878279339067816479233688850376089318
                )
            ],
            [
                Base.from(
                    138379964217730043214483648698160629483863013526509407892111571356669116045
                ),
                Base.from(
                    1135532281155277588005319334542025976079676424839948500020664227027300010929
                ),
                Base.from(
                    4384117336930380014868572224801371377488688194169758696438185377724744869360
                )
            ],
            [
                Base.from(
                    2172557757571027007180888233590037090942460444708335347189200402618049219364
                ),
                Base.from(
                    676128913284806802699862508051022306366147359505124346651466289788974059668
                ),
                Base.from(
                    25186611339598418732666781049829183886812651492845008333418424746493100589207
                )
            ],
            [
                Base.from(
                    1040224012466476373306009423769696447360958041419094467177876175388788434107
                ),
                Base.from(
                    11918307118590866200687906627767559273324023585642003803337447146531313172441
                ),
                Base.from(
                    16895677254395661024186292503536662354181715337630376909778003268311296637301
                )
            ],
            [
                Base.from(
                    2381860269903274166987449845669632570549838313022129758039903577811921322481
                ),
                Base.from(
                    4285193711150023248690088154344086684336247475445482883105661485741762600154
                ),
                Base.from(
                    19133204443389422404056150665863951250222934590192266371578950735825153238612
                )
            ],
            [
                Base.from(
                    551558967326650403353390683649400270286646379176218714009956058319897423339
                ),
                Base.from(
                    11830435563729472715615302060564876527985621376031612798386367965451821182352
                ),
                Base.from(
                    7510711479224915247011074129666445216001563200717943545636462819681638560128
                )
            ],
            [
                Base.from(
                    2469484320190772294009150362673183005655012822529737021761032857873338773344
                ),
                Base.from(
                    27361655066973784653563425664091383058914302579694897188019422193564924110528
                ),
                Base.from(
                    21606788186194534241166833954371013788633495786419718955480491478044413102713
                )
            ],
            [
                Base.from(
                    1993406006339090540930940760781478733515902181653700600339803523770792400675
                ),
                Base.from(
                    8495813630060004961768092461554180468161254914257386012937942498774724649553
                ),
                Base.from(
                    27524960680529762202005330464726908693944660961000958842417927307941561848461
                )
            ],
            [
                Base.from(
                    1517848165095039925975780540061563570308625503507391911466725454969086289698
                ),
                Base.from(
                    16164780354695672259791105197274509251141405713012804937107314962551600380870
                ),
                Base.from(
                    10529167793600778056702353412758954281652843049850979705476598375597148191979
                )
            ],
            [
                Base.from(
                    72114107017907408255330289629216710375538474108333895781864472829050144904
                ),
                Base.from(
                    22044408985956234023934090378372374883099115753118261312473550998188148912041
                ),
                Base.from(
                    27068254103241989852888872162525066148367014691482601147536314217249046186315
                )
            ],
            [
                Base.from(
                    388042924195635717681911209879274458437672745021187399869958089362486874896
                ),
                Base.from(
                    17387097125522937623262508065966749501583017524609697127088211568136333655623
                ),
                Base.from(
                    6256814421247770895467770393029354017922744712896100913895513234184920631289
                )
            ],
            [
                Base.from(
                    294262734777733718769093967160125198750028593734038632874681886197271140857
                ),
                Base.from(
                    24031654937764287280548628128490074801809101323243546313826173430897408945397
                ),
                Base.from(
                    14401457902976567713827506689641442844921449636054278900045849050301331732143
                )
            ],
            [
                Base.from(
                    2017063287738540645074219983693390025769262435388984835240759079421183913072
                ),
                Base.from(
                    24056496193857444725324410428861722338174099794084586764867109123681727290181
                ),
                Base.from(
                    11257913009612703357266904349759250619633397075667824800196659858304604714965
                )
            ],
            [
                Base.from(
                    2222815892198442574919907146151015269402575787156140689704178803711693100924
                ),
                Base.from(
                    9152163378317846541430311327336774331416267016980485920222768197583559318682
                ),
                Base.from(
                    13906695403538884432896105059360907560653506400343268230130536740148070289175
                )
            ],
            [
                Base.from(
                    722071456250972143703424178673118529197249695209125493119541485596234402506
                ),
                Base.from(
                    27608867305903811397208862801981345878179337369367554478205559689592889691927
                ),
                Base.from(
                    13288465747219756218882697408422850918209170830515545272152965967042670763153
                )
            ],
            [
                Base.from(
                    825134389270914015456705177298066260956635921574361377315506562750481332765
                ),
                Base.from(
                    22035238365102171608166944627493632660244312563934708756134297161332908879090
                ),
                Base.from(
                    13560937766273321037807329177749403409731524715067067740487246745322577571823
                )
            ],
            [
                Base.from(
                    2165251860895923455026255913528535802055289734993457116403233918699680540804
                ),
                Base.from(
                    22479086963324173427634460342145551255011746993910136574926173581069603086891
                ),
                Base.from(
                    13676501958531751140966255121288182631772843001727158043704693838707387130095
                )
            ],
            [
                Base.from(
                    568031039410257795056893019905670782760827530647999466319718703189324482667
                ),
                Base.from(
                    25125360450906166639190392763071557410047335755341060350879819485506243289998
                ),
                Base.from(
                    22659254028501616785029594492374243581602744364859762239504348429834224676676
                )
            ],
            [
                Base.from(
                    2310141140508751217142183885675944817751267986988298763107356944149672253678
                ),
                Base.from(
                    24149774013240355952057123660656464942409328637280437515964899830988178868108
                ),
                Base.from(
                    5782097512368226173095183217893826020351125522160843964147125728530147423065
                )
            ],
            [
                Base.from(
                    1354076211450008386992056464939997764434424748531399044812983891023120486811
                ),
                Base.from(
                    20421637734328811337527547703833013277831804985438407401987624070721139913982
                ),
                Base.from(
                    7742664118615900772129122541139124149525273579639574972380600206383923500701
                )
            ],
            [
                Base.from(
                    110964380105396302177841877319654364397014666632966126882569123029479897631
                ),
                Base.from(
                    16580663920817053843121063692728699890952505074386761779275436996241901223840
                ),
                Base.from(
                    14638514680222429058240285918830106208025229459346033470787111294847121792366
                )
            ],
            [
                Base.from(
                    1708038585781267264948921796528572773955757346701439282299202126470156320589
                ),
                Base.from(
                    26176268111736737558502775993925696791974738793095023824029827577569530708665
                ),
                Base.from(
                    4382756253392449071896813428140986330161215829425086284611219278674857536001
                )
            ],
            [
                Base.from(
                    1393403381494058531540666644596047129363842740497155389161753323117881534890
                ),
                Base.from(
                    27054912732979753314774418228399230433963143177662848084045249524271046173121
                ),
                Base.from(
                    28916070403698593376490976676534962592542013020010643734621202484860041243391
                )
            ],
            [
                Base.from(
                    2482001563696636015016445809489458776538413525944629527810199813093496392238
                ),
                Base.from(
                    7969535238488580655870884015145760954416088335296905520306227531221721881868
                ),
                Base.from(
                    7690547696740080985104189563436871930607055124031711216224219523236060212249
                )
            ],
            [
                Base.from(
                    971257646809127238449624835341429090837782569748875713483320524610660586728
                ),
                Base.from(
                    12148698031438398980683630141370402088785182722473169207262735228500190477924
                ),
                Base.from(
                    14359657643133476969781351728574842164124292705609900285041476162075031948227
                )
            ],
            [
                Base.from(
                    2356383996537206727513799280103578001342222899772428606097503571904535243547
                ),
                Base.from(
                    4184634822776323233231956802962638484057536837393405750680645555481330909086
                ),
                Base.from(
                    16249511905185772125762038789038193114431085603985079639889795722501216492487
                )
            ],
            [
                Base.from(
                    1100186304869203155980067347352631161670286382606355055956831579443894151662
                ),
                Base.from(
                    4702354107983530219070178410740869035350641284373933887080161024348425080464
                ),
                Base.from(
                    23751680507533064238793742311430343910720206725883441625894258483004979501613
                )
            ],
            [
                Base.from(
                    2867052651615845147016987349654173954586017775779332909304552243227909451876
                ),
                Base.from(
                    3568312993091537758218792253361873752799472566055209125947589819564395417072
                ),
                Base.from(
                    1819755756343439646550062754332039103654718693246396323207323333948654200950
                )
            ],
            [
                Base.from(
                    537212995469979130195394890734988725775224784384451106989676678462493047827
                ),
                Base.from(
                    17512156688034945920605615850550150476471921176481039715733979181538491476080
                ),
                Base.from(
                    25777105342317622165159064911913148785971147228777677435200128966844208883059
                )
            ],
            [
                Base.from(
                    2535039200615874174913423830632626575608545515701270158600330087263788715798
                ),
                Base.from(
                    20096724945283767296886159120145376967480397366990493578897615204296873954844
                ),
                Base.from(
                    8063283381910110762785892100479219642751540456251198202214433355775540036851
                )
            ],
            [
                Base.from(
                    439361387046229738556527775720701082490072321772022613034246366635155747582
                ),
                Base.from(
                    9874972555132910032057499689351411450892722671352476280351715757363137891038
                ),
                Base.from(
                    23590926474329902351439438151596866311245682682435235170001347511997242904868
                )
            ],
            [
                Base.from(
                    1772337337113727585946751861555127858484294796389479103229677495586995821107
                ),
                Base.from(
                    2350345015303336966039836492267992193191479606566494799781846958620636621159
                ),
                Base.from(
                    27755207882790211140683010581856487965587066971982625511152297537534623405016
                )
            ],
            [
                Base.from(
                    658460798778918540812360184910626090767131499437822506680606086271081419390
                ),
                Base.from(
                    609759108847171587253578490536519506369136135254150754300671591987320319770
                ),
                Base.from(
                    28435187585965602110074342250910608316032945187476441868666714022529803033083
                )
            ],
            [
                Base.from(
                    1601666491165177066393891645024570590828719296425470464171775110346432245530
                ),
                Base.from(
                    17551273293154696089066968171579395800922204266630874071186322718903959339163
                ),
                Base.from(
                    20414195497994754529479032467015716938594722029047207834858832838081413050198
                )
            ],
            [
                Base.from(
                    1977330791885068546318029096677446580553752059560249652962456818499348759385
                ),
                Base.from(
                    24598603838812162820757838364185126333280131847747737533989799467867231166980
                ),
                Base.from(
                    11040972566103463398651864390163813377135738019556270484707889323659789290225
                )
            ],
            [
                Base.from(
                    518924208095778403886018818444328756248896302392208672385086398743781839381
                ),
                Base.from(
                    1435203288979376557721239239445613396009633263160237764653161500252258220144
                ),
                Base.from(
                    13066591163578079667911016543985168493088721636164837520689376346534152547210
                )
            ],
            [
                Base.from(
                    1734590140701359941814821046515086578262842204745802480749050248971125283134
                ),
                Base.from(
                    22139633362249671900128029132387275539363684188353969065288495002671733200348
                ),
                Base.from(
                    1061056418502836172283188490483332922126033656372467737207927075184389487061
                )
            ],
            [
                Base.from(
                    1024173890619085741604622992845555182918919694123960175637566512987483523229
                ),
                Base.from(
                    27808033332417845112292408673209999320983657696373938259351951416571545364415
                ),
                Base.from(
                    18820154989873674261497645724903918046694142479240549687085662625471577737140
                )
            ],
            [
                Base.from(
                    798368843521464084267329473543919601065495122695610127176384952752994061930
                ),
                Base.from(
                    17067928657801807648925755556866676899145460770352731818062909643149568271566
                ),
                Base.from(
                    24472070825156236829515738091791182856425635433388202153358580534810244942762
                )
            ],
            [
                Base.from(
                    2575220116936179591125862573101671741431098645000473751459524103803693628322
                ),
                Base.from(
                    26041505376284666160132119888949817249574689146924196064963008712979256107535
                ),
                Base.from(
                    23977050489096115210391718599021827780049209314283111721864956071820102846008
                )
            ],
            [
                Base.from(
                    2667825709727878841067602671873608731281601674901673893394213460072596241380
                ),
                Base.from(
                    10480026985951498884090911619636977502506079971893083605102044931823547311729
                ),
                Base.from(
                    21126631300593007055117122830961273871167754554670317425822083333557535463396
                )
            ],
            [
                Base.from(
                    156486289421543417764115628769910665937964885145768146984836253213140682757
                ),
                Base.from(
                    13247162472821152334486419054854847522301612781818744556576865965657773174584
                ),
                Base.from(
                    8673615954922496961704442777870253767001276027366984739283715623634850885984
                )
            ],
            [
                Base.from(
                    279452507693749080747666694260226229867729173572312986845762950855542947008
                ),
                Base.from(
                    4656175953888995612264371467596648522808911819700660048695373348629527757049
                ),
                Base.from(
                    23221574237857660318443567292601561932489621919104226163978909845174616477329
                )
            ],
            [
                Base.from(
                    187839246007827231771611445878463651760314271609131689305436515306822711714
                ),
                Base.from(
                    2370412714505757731457251173604396662292063533194555369091306667486647634097
                ),
                Base.from(
                    17409784861870189930766639925394191888667317762328427589153989811980152373276
                )
            ],
            [
                Base.from(
                    2586913664189816651411194170860804826958423324277381401438556410116877429319
                ),
                Base.from(
                    11361209360311194794795494027949518465383235799633128250259863567683341091323
                ),
                Base.from(
                    14913258820718821235077379851098720071902170702113538811112331615559409988569
                )
            ],
            [
                Base.from(
                    1295701202201830441986828703351314173699521190668290391589751595429067837389
                ),
                Base.from(
                    17128889547450684566010972445328859295804027707361763477802050112063630550300
                ),
                Base.from(
                    23329219085372232771288306767242735245018143857623151155581182779769305489903
                )
            ],
            [
                Base.from(
                    160774102796293368547652727585893869972858679439838234845473601878456885393
                ),
                Base.from(
                    2611953825405141009309433982109911976923326848135736099261873796908057448476
                ),
                Base.from(
                    7372230383134982628913227482618052530364724821976589156840317933676130378411
                )
            ],
            [
                Base.from(
                    2020360675850121262084273512377001495249975475143066046306069699031755681857
                ),
                Base.from(
                    4678361398979174017885631008335559529633853759463947250620930343087749944307
                ),
                Base.from(
                    27176462634198471376002287271754121925750749676999036165457559387195124025594
                )
            ],
            [
                Base.from(
                    636198181355261469792869752733231853050285201518904883807256581123020447464
                ),
                Base.from(
                    13815234633287489023151647353581705241145927054858922281829444557905946323248
                ),
                Base.from(
                    10888828634279127981352133512429657747610298502219125571406085952954136470354
                )
            ]
        ];
        // taken from kimchi's dummy values

        new_state[0] = sbox(state[0]);
        new_state[1] = sbox(state[1]);
        new_state[2] = sbox(state[2]);

        new_state = apply_mds(new_state);

        new_state[0] = new_state[0].add(round_constants[round][0]);
        new_state[1] = new_state[1].add(round_constants[round][1]);
        new_state[2] = new_state[2].add(round_constants[round][2]);
    }

    function permutation(
        Base.FE[3] memory state
    ) public pure returns (Base.FE[3] memory new_state) {
        uint ROUNDS = 55;

        new_state = state;
        for (uint round = 0; round < ROUNDS; round++) {
            new_state = apply_round(round, new_state);
        }
    }
}
